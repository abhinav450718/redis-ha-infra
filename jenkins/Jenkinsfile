pipeline {
    agent any

    environment {
        ANSIBLE_HOST_KEY_CHECKING = "False"
        PRIVATE_KEY = "${WORKSPACE}/terraform/redis_key.pem"
        BASTION_IP = "18.230.148.128"           // replace with terraform output if dynamic
        REDIS_MASTER_IP = "10.0.1.169"
        REDIS_REPLICA_IP = "10.0.2.31"
    }

    stages {

        stage('Prepare Ansible') {
            steps {
                dir('ansible') {
                    sh 'ansible-galaxy install -r requirements.yml --force'
                }
            }
        }

        stage('Create Inventory') {
            steps {
                dir('ansible') {
                    writeFile file: 'inventory/hosts.ini', text: """
[bastion]
${BASTION_IP} ansible_user=ubuntu ansible_ssh_private_key_file=../terraform/redis_key.pem

[redis_master]
${REDIS_MASTER_IP} ansible_user=ubuntu ansible_ssh_private_key_file=../terraform/redis_key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -J ubuntu@${BASTION_IP}'

[redis_replica]
${REDIS_REPLICA_IP} ansible_user=ubuntu ansible_ssh_private_key_file=../terraform/redis_key.pem ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -J ubuntu@${BASTION_IP}'
"""
                }
            }
        }

        stage('Run Playbook') {
            steps {
                dir('ansible') {
                    sh """
                    ansible-playbook -i inventory/hosts.ini playbook.yml --private-key ${PRIVATE_KEY}
                    """
                }
            }
        }
    }

    post {
        success {
            echo '✅ Redis setup completed successfully!'
        }
        failure {
            echo '❌ Redis setup failed. Check logs.'
        }
    }
}
