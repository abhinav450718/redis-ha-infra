pipeline {
    agent any

    environment {
        AWS_DEFAULT_REGION = 'sa-east-1'
        TERRAFORM_DIR = 'terraform'
        ANSIBLE_DIR = 'ansible'
    }

    stages {

        stage('Checkout Repo') {
            steps {
                git(
                    url: 'https://github.com/abhinav450718/redis-ha-infra.git',
                    branch: 'main',
                    credentialsId: 'aws-creds'
                )
            }
        }

        stage('Terraform Init & Apply') {
            steps {
                dir("${TERRAFORM_DIR}") {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
            }
        }

        stage('Generate Dynamic Inventory') {
            steps {
                dir("${TERRAFORM_DIR}") {
                    script {
                        env.REDIS_MASTER_IP = sh(script: "terraform output -raw redis_master_private_ip", returnStdout: true).trim()
                        env.REDIS_REPLICA_IP = sh(script: "terraform output -raw redis_replica_private_ip", returnStdout: true).trim()
                        env.BASTION_IP = sh(script: "terraform output -raw bastion_public_ip", returnStdout: true).trim()
                    }

                    // Generate dynamic inventory file for Ansible
                    writeFile file: '../ansible/inventory/hosts.ini', text: """
[redis_master]
${env.REDIS_MASTER_IP}

[redis_replica]
${env.REDIS_REPLICA_IP}

[bastion]
${env.BASTION_IP}
"""
                }
            }
        }

        stage('Install Ansible Roles') {
            steps {
                dir("${ANSIBLE_DIR}") {
                    sh 'ansible-galaxy install -r requirements.yml --force'
                }
            }
        }

        stage('Install Redis via Ansible') {
            steps {
                dir("${ANSIBLE_DIR}") {
                    withCredentials([sshUserPrivateKey(credentialsId: 'aws-redis-key', keyFileVariable: 'KEYFILE', usernameVariable: 'SSHUSER')]) {
                        sh """
                        ansible-playbook -i inventory/hosts.ini playbook.yml \
                        --user ubuntu \
                        --private-key \$KEYFILE \
                        --extra-vars "bastion_ip=${env.BASTION_IP}"
                        """
                    }
                }
            }
        }

        stage('Test Redis Connectivity') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: 'aws-redis-key', keyFileVariable: 'KEYFILE', usernameVariable: 'SSHUSER')]) {
                    script {
                        echo "Testing Redis Master via Bastion..."
                        sh """
                        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i \$KEYFILE \
                        -J ubuntu@${env.BASTION_IP} ubuntu@${env.REDIS_MASTER_IP} redis-cli ping
                        """

                        echo "Testing Redis Replica via Bastion..."
                        sh """
                        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i \$KEYFILE \
                        -J ubuntu@${env.BASTION_IP} ubuntu@${env.REDIS_REPLICA_IP} redis-cli ping
                        """
                    }
                }
            }
        }
    }

    post {
        always {
            echo 'Pipeline finished. Check Terraform and Ansible logs for details.'
        }
        success {
            echo '✅ Redis cluster deployed successfully!'
        }
        failure {
            echo '❌ Pipeline failed. Investigate logs.'
        }
    }
}
