pipeline {
    agent any

    environment {
        AWS_REGION = 'sa-east-1'
        AWS_CREDENTIALS = 'aws-creds'          // Jenkins AWS credentials ID
        ANSIBLE_PRIVATE_KEY = 'aws-redis-key' // Jenkins SSH private key ID
    }

    stages {

        stage('Checkout Repo') {
            steps {
                git branch: 'main', url: 'https://github.com/abhinav450718/redis-ha-infra.git', credentialsId: "${AWS_CREDENTIALS}"
            }
        }

        stage('Terraform Apply') {
            steps {
                withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: "${AWS_CREDENTIALS}"]]) {
                    dir('terraform') {
                        sh 'terraform init'
                        sh 'terraform apply -auto-approve'
                    }
                }
            }
        }

        stage('Generate Dynamic Ansible Inventory and Vars') {
            steps {
                dir('terraform') {
                    script {
                        def redis_master_ip = sh(script: 'terraform output -raw redis_master_private_ip', returnStdout: true).trim()
                        def redis_replica_ip = sh(script: 'terraform output -raw redis_replica_private_ip', returnStdout: true).trim()
                        def bastion_ip = sh(script: 'terraform output -raw bastion_public_ip', returnStdout: true).trim()

                        writeFile file: '../ansible/inventory/hosts.ini', text: """
[redis_master]
${redis_master_ip} ansible_user=ubuntu ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -J ubuntu@${bastion_ip}'

[redis_replica]
${redis_replica_ip} ansible_user=ubuntu ansible_ssh_common_args='-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -J ubuntu@${bastion_ip}'
"""

                        writeFile file: '../ansible/group_vars/all.yml', text: """
redis_master_ip: ${redis_master_ip}
redis_replica_ip: ${redis_replica_ip}
redis_port: 6379
"""
                    }
                }
            }
        }

        stage('Install Redis via Ansible') {
            steps {
                withCredentials([sshUserPrivateKey(credentialsId: "${ANSIBLE_PRIVATE_KEY}", keyFileVariable: 'KEYFILE', usernameVariable: 'SSHUSER')]) {
                    dir('ansible') {
                        sh 'ansible-galaxy install -r requirements.yml --force'
                        sh "ANSIBLE_HOST_KEY_CHECKING=False ansible-playbook playbook.yml -i inventory/hosts.ini --private-key $KEYFILE"
                    }
                }
            }
        }

        stage('Test Redis Connectivity via Bastion') {
            steps {
                dir('terraform') {
                    script {
                        def redis_master_ip = sh(script: 'terraform output -raw redis_master_private_ip', returnStdout: true).trim()
                        def redis_replica_ip = sh(script: 'terraform output -raw redis_replica_private_ip', returnStdout: true).trim()
                        def bastion_ip = sh(script: 'terraform output -raw bastion_public_ip', returnStdout: true).trim()

                        sh "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ../ansible/redis_key.pem -J ubuntu@${bastion_ip} ubuntu@${redis_master_ip} 'redis-cli ping'"
                        sh "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -i ../ansible/redis_key.pem -J ubuntu@${bastion_ip} ubuntu@${redis_replica_ip} 'redis-cli ping'"
                    }
                }
            }
        }

    }

    post {
        always {
            echo 'Pipeline finished. Check Terraform, Ansible, and SSH logs for details.'
        }
        failure {
            echo 'Pipeline failed. Inspect Terraform, Ansible, and connectivity steps.'
        }
    }
}
